# =============================================================================
# Promtail Configuration for Ronak-Verse
# =============================================================================
# Collects logs from Docker containers and ships to Loki
# =============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://ronak-verse-loki:3100/loki/api/v1/push

scrape_configs:
  # ===========================================================================
  # DOCKER CONTAINERS - Automatic Discovery
  # ===========================================================================
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["application"]  # Only scrape containers with 'application' label

    relabel_configs:
      # Extract container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'

      # Extract application label (puzzle, gateway, infrastructure, etc.)
      - source_labels: ['__meta_docker_container_label_application']
        target_label: 'application'

      # Extract service label (api-gateway, auth-service, etc.)
      - source_labels: ['__meta_docker_container_label_service']
        target_label: 'service'

      # Extract compose service name
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'compose_service'

      # Add environment label
      - replacement: 'production'
        target_label: 'environment'

    # Pipeline stages for log processing
    pipeline_stages:
      # Parse JSON logs (if present)
      - json:
          expressions:
            level: level
            msg: message
            user_id: user_id
            request_id: request_id

      # Extract log level from various formats
      - regex:
          expression: '(?P<level>ERROR|WARN|INFO|DEBUG)'

      # Add timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Add labels from extracted fields
      - labels:
          level:
          user_id:

  # ===========================================================================
  # SYSTEM LOGS (Optional)
  # ===========================================================================
  # - job_name: system
  #   static_configs:
  #     - targets:
  #         - localhost
  #       labels:
  #         job: syslog
  #         application: system
  #         __path__: /var/log/syslog

# =============================================================================
# NOTES
# =============================================================================
# - Promtail automatically discovers all Docker containers with 'application' label
# - Logs are enriched with application, service, container labels
# - JSON logs are automatically parsed
# - Log levels are extracted for easy filtering in Grafana
